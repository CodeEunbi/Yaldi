# Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

## ê°œìš”

Yaldi í”„ë¡œì íŠ¸ëŠ” **Flyway**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ë²„ì „ ê´€ë¦¬í•©ë‹ˆë‹¤.

- í•œ ë²ˆ ì‹¤í–‰ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ì¬ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- `flyway_schema_history` í…Œì´ë¸”ì— ì‹¤í–‰ ì´ë ¥ ê¸°ë¡
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰

## JPA ëŒ€ì‹  Flywayë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

JPAì˜ `ddl-auto: update`ëŠ” **Entity ê¸°ë°˜**ìœ¼ë¡œë§Œ ìŠ¤í‚¤ë§ˆë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ YaldiëŠ” ë‹¤ìŒê³¼ ê°™ì€ **PostgreSQL ë„¤ì´í‹°ë¸Œ ê¸°ëŠ¥**ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— Flywayê°€ í•„ìˆ˜ì…ë‹ˆë‹¤:

### 1. Trigger (íŠ¸ë¦¬ê±°)
- Soft Delete Cascade
- Last Activity ìë™ ì—…ë°ì´íŠ¸
- ì‚¬ìš©ì ì¬ê°€ì… ì‹œ ë°ì´í„° ë³µêµ¬

### 2. PostgreSQL Extensions
- `pgvector`: ë²¡í„° ê²€ìƒ‰ (AI ê¸°ëŠ¥)

### 3. Custom ENUM Types
- `design_verification_status_type`
- `relation_type`
- `referential_action_type`
- `project_member_role_type`

### 4. Complex Constraints
- Partial Unique Index (soft delete ê³ ë ¤)
- Custom CHECK constraints

### 5. Functions
- PL/pgSQL í•¨ìˆ˜ë“¤

**JPAëŠ” Java Entityë§Œ ê´€ë¦¬í•˜ì§€ë§Œ, FlywayëŠ” SQLë¡œ ëª¨ë“  DB ê¸°ëŠ¥ì„ ì§ì ‘ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

## í˜„ì¬ ë§ˆì´ê·¸ë ˆì´ì…˜

```
src/main/resources/db/migration/
â”œâ”€â”€ V20251115001__init_database_schema.sql  (ì „ì²´ ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”)
â””â”€â”€ V20251115002__insert_mock_data.sql      (ê°œë°œìš© ëª© ë°ì´í„°)
```

## ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ëª…ëª… ê·œì¹™

```
V{YYYYMMDDXXX}__{ì„¤ëª…}.sql
```

**ì˜ˆì‹œ:**
```
V20251116001__add_user_profile_table.sql
V20251116002__add_email_verification.sql
V20251117001__fix_constraint.sql
```

- **YYYYMMDD**: ì˜¤ëŠ˜ ë‚ ì§œ (8ìë¦¬)
- **XXX**: ì¼ì¼ ì‹œí€€ìŠ¤ (001, 002, ...)
- **ì„¤ëª…**: ì˜ë¬¸ snake_case

## ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë°©ë²•

### 1. ìƒˆ í…Œì´ë¸” ì¶”ê°€

```bash
# íŒŒì¼ ìƒì„±
touch src/main/resources/db/migration/V20251116001__add_user_profiles.sql
```

```sql
-- V20251116001__add_user_profiles.sql

CREATE TABLE IF NOT EXISTS user_profiles (
    profile_key BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    user_key    INTEGER NOT NULL,
    bio         VARCHAR(500),
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
    PRIMARY KEY (profile_key),
    CONSTRAINT fk_user_profiles_user_key
        FOREIGN KEY (user_key) REFERENCES users(user_key) ON DELETE CASCADE
);

CREATE INDEX idx_user_profiles_user_key ON user_profiles(user_key);
```

### 2. ì»¬ëŸ¼ ì¶”ê°€

```sql
-- V20251116002__add_user_phone.sql

ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);
CREATE INDEX IF NOT EXISTS idx_users_phone ON users(phone);
```

### 3. ì»¬ëŸ¼ ìˆ˜ì •

```sql
-- V20251116003__modify_user_nickname_length.sql

ALTER TABLE users ALTER COLUMN nickname TYPE VARCHAR(20);
```

### 4. ì»¬ëŸ¼ ì‚­ì œ

```sql
-- V20251116004__remove_user_legacy_field.sql

ALTER TABLE users DROP COLUMN IF EXISTS legacy_field;
```

### 5. ì œì•½ì¡°ê±´ ì¶”ê°€/ìˆ˜ì •

```sql
-- V20251116005__add_email_unique_constraint.sql

-- ê¸°ì¡´ ì œì•½ ì‚­ì œ (ìˆë‹¤ë©´)
ALTER TABLE users DROP CONSTRAINT IF EXISTS users_email_key;

-- ìƒˆ ì œì•½ ì¶”ê°€
ALTER TABLE users ADD CONSTRAINT users_email_unique UNIQUE (email);
```

### 6. ì¸ë±ìŠ¤ ì¶”ê°€

```sql
-- V20251116006__add_performance_indexes.sql

CREATE INDEX IF NOT EXISTS idx_projects_created_at ON projects(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_versions_project_status ON versions(project_key, design_verification_status);
```

### 7. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

```sql
-- V20251116007__migrate_user_data.sql

-- ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸
UPDATE users SET status = 'ACTIVE' WHERE status IS NULL;

-- ë°ì´í„° ì´ë™
INSERT INTO user_profiles (user_key, bio)
SELECT user_key, legacy_bio FROM users WHERE legacy_bio IS NOT NULL;
```

### 8. íŠ¸ë¦¬ê±° ì¶”ê°€/ìˆ˜ì •

```sql
-- V20251116008__add_audit_trigger.sql

CREATE OR REPLACE FUNCTION update_modified_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_users_update_timestamp
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_modified_timestamp();
```

## ì‹¤í–‰ ë°©ë²•

### ê°œë°œ í™˜ê²½ (ë¡œì»¬)

```bash
# 1. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± ë° ì‘ì„±
touch src/main/resources/db/migration/V20251116001__your_change.sql

# 2. DBê°€ ì—†ìœ¼ë©´ ì‹¤í–‰
docker-compose up -d postgres

# 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (Flyway ìë™ ì‹¤í–‰)
./gradlew bootRun
```

### ë°°í¬ í™˜ê²½ (ìš´ì˜/ìŠ¤í…Œì´ì§•)

```bash
# 1. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì¶”ê°€ í›„ ì»¤ë°‹/í‘¸ì‹œ

# 2. ì„œë²„ì—ì„œ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ ì¬ì‹œì‘
# (DBëŠ” ì´ë¯¸ Docker Composeë¡œ ì‹¤í–‰ ì¤‘)
./gradlew bootRun
# ë˜ëŠ”
java -jar build/libs/yaldi-0.0.1-SNAPSHOT.jar

# Flywayê°€ ìë™ìœ¼ë¡œ ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°ì§€ ë° ì‹¤í–‰
```

**ì¤‘ìš”**: ë°°í¬ í™˜ê²½ì—ì„œëŠ” DBë¥¼ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ ì¬ì‹œì‘í•˜ë©´ Flywayê°€ ìë™ìœ¼ë¡œ ë¯¸ì‹¤í–‰ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ê°ì§€í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.

## ì¤‘ìš” ê·œì¹™

### âš ï¸ ì ˆëŒ€ ê¸ˆì§€

- **ì‹¤í–‰ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìˆ˜ì • ê¸ˆì§€** (ì²´í¬ì„¬ ì˜¤ë¥˜ ë°œìƒ)
- í•­ìƒ ìƒˆë¡œìš´ íŒŒì¼ë¡œ ì¶”ê°€

```bash
# âŒ ì˜ëª»ëœ ë°©ë²•
vim V20251115001__init_database_schema.sql  # ì´ë¯¸ ì‹¤í–‰ëœ íŒŒì¼ ìˆ˜ì •

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
touch V20251116001__fix_previous_issue.sql  # ìƒˆ íŒŒì¼ ìƒì„±
```

### ğŸ“… ë²„ì „ ë²ˆí˜¸ ê·œì¹™

- í•­ìƒ **í˜„ì¬ ë‚ ì§œ** ì‚¬ìš©
- ê³¼ê±° ë‚ ì§œ ì‚¬ìš© ê¸ˆì§€ (ìˆœì„œ ì˜¤ë¥˜)

```bash
# âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
V20251116001, V20251116002, V20251117001

# âŒ ì˜ëª»ëœ ì˜ˆ
V20251116001, V20251117001, V20251116002  # ì´ë¯¸ V20251117001 ì‹¤í–‰ í›„ ì´ì „ ë‚ ì§œ ì¶”ê°€ ë¶ˆê°€
```

### ğŸ”’ íŠ¸ëœì­ì…˜

- ê° íŒŒì¼ì€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰
- ì‹¤íŒ¨ ì‹œ ì „ì²´ ë¡¤ë°±
- ê´€ë ¨ëœ ë³€ê²½ì‚¬í•­ë§Œ í•œ íŒŒì¼ì— í¬í•¨

## ê°œë°œ í™˜ê²½ íŒ

### DB ì´ˆê¸°í™” í›„ ì¬ì‹¤í–‰

```bash
# ê°œë°œ ì¤‘ ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš°
docker-compose down -v
docker-compose up -d postgres
./gradlew bootRun
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë ¥ í™•ì¸

```sql
SELECT version, description, installed_on, success
FROM flyway_schema_history
ORDER BY installed_rank;
```

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Checksum ì˜¤ë¥˜

```
FlywayValidateException: Migration checksum mismatch
```

**í•´ê²°**: ì‹¤í–‰ëœ íŒŒì¼ì„ ìˆ˜ì •í–ˆì„ ë•Œ ë°œìƒ. ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë¡œ ìˆ˜ì •ì‚¬í•­ ì¶”ê°€

### ìˆœì„œ ì˜¤ë¥˜

ì´ë¯¸ ë” ë†’ì€ ë²„ì „ì´ ì‹¤í–‰ëœ ê²½ìš°, ë‚®ì€ ë²„ì „ ì¶”ê°€ ë¶ˆê°€

**í•´ê²°**: í•­ìƒ í˜„ì¬ ë‚ ì§œë¡œ ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±

### Migration rolled back ì˜¤ë¥˜ (ê¸°ì¡´ DBì— Flyway ì ìš© ì‹œ)

```
Migration of schema "public" to version "20251115001 - init database schema" failed!
Changes successfully rolled back
```

**ì›ì¸**: ê¸°ì¡´ DBì— ìŠ¤í‚¤ë§ˆê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ë° Flywayê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ë ¤ë‹¤ ì¶©ëŒ

**í•´ê²°**: Flyway íˆìŠ¤í† ë¦¬ í…Œì´ë¸”ì„ ì‚­ì œí•˜ê³  baseline ê¸°ëŠ¥ ì‚¬ìš©

```bash
# 1. Flyway íˆìŠ¤í† ë¦¬ í…Œì´ë¸” ì‚­ì œ
docker exec -i yaldi-postgres psql -U postgres -d yaldi -c "DROP TABLE IF EXISTS flyway_schema_history CASCADE;"

# 2. application-prod.ymlì— baseline ì„¤ì •ì´ ìˆëŠ”ì§€ í™•ì¸
# baseline-on-migrate: true
# baseline-version: 20251115002

# 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
```

ì´ë ‡ê²Œ í•˜ë©´ Flywayê°€ ê¸°ì¡´ ìŠ¤í‚¤ë§ˆë¥¼ 20251115002ê¹Œì§€ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ê³ , ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤.

## ì°¸ê³ 

- [Flyway ê³µì‹ ë¬¸ì„œ](https://flywaydb.org/documentation/)
- ì„¤ì • íŒŒì¼: `src/main/resources/application.yml`
- ë§ˆì´ê·¸ë ˆì´ì…˜ ìœ„ì¹˜: `src/main/resources/db/migration/`
