
# EC2 내 배포용 docker-compose.yml

name: yaldi

services:
  jenkins:
    profiles: ["jenkins"]
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    container_name: jenkins
    user: root
    hostname: jenkins
    expose:
      - "8080"
      - "50000"
    volumes:
      - /home/ubuntu/yaldi/volumes/jenkins:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - /usr/libexec/docker:/usr/libexec/docker:ro
      - /home/ubuntu/yaldi:/workspace:ro
      - /home/ubuntu/yaldi/frontend:/workspace/frontend:rw
    environment:
      JAVA_OPTS: >-
        -Xmx2g -Xms512m
        -Duser.timezone=Asia/Seoul
        -Dhudson.model.DirectoryBrowserSupport.CSP=
    networks:
      - network
    restart: unless-stopped

  postgres:
    profiles: ["db"]
    image: pgvector/pgvector:pg16
    container_name: postgres
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: UTC
    volumes:
      - /home/ubuntu/yaldi/volumes/postgres:/var/lib/postgresql/data
    networks:
      - network
    restart: unless-stopped
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=2621kB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

  redis:
    profiles: ["db"]
    image: redis:7-alpine
    container_name: redis
    hostname: redis
    expose:
      - "6379"
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 300
    volumes:
      - /home/ubuntu/yaldi/volumes/redis:/data
    environment:
      TZ: UTC
    networks:
      - network
    restart: unless-stopped

  elasticsearch:
    profiles: ["search"]
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    hostname: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - TZ=UTC
      - bootstrap.memory_lock=true
      - cluster.name=yaldi-cluster
      - node.name=yaldi-node-1
    # ulimits:
    #   memlock:
    #     soft: -1
    #     hard: -1
    #   nofile:
    #     soft: 65536
    #     hard: 65536
    volumes:
      - /home/ubuntu/yaldi/volumes/elasticsearch:/usr/share/elasticsearch/data
    expose:
      - "9200"
      - "9300"
    networks:
      - network
    restart: unless-stopped

  kafka:
      profiles: ["kafka"]
      image: apache/kafka:3.8.1
      container_name: kafka
      hostname: kafka
      user: root
      expose:
        - "9092"
      environment:
        TZ: UTC

        # === KRaft 모드 설정 ===
        KAFKA_NODE_ID: 1
        KAFKA_PROCESS_ROLES: broker,controller
        KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9094

        # 리스너 설정
        KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9094
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
        KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
        KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

        # Cluster ID
        CLUSTER_ID: ${KAFKA_CLUSTER_ID:-MkU3OEVBNTcwNTJENDM2Qk}

        # 로그 디렉토리
        KAFKA_LOG_DIRS: /var/lib/kafka/data

        # 성능 최적화
        KAFKA_HEAP_OPTS: "-Xmx512m -Xms256m"
        KAFKA_NUM_NETWORK_THREADS: 3
        KAFKA_NUM_IO_THREADS: 8
        KAFKA_SOCKET_SEND_BUFFER_BYTES: 102400
        KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 102400
        KAFKA_SOCKET_REQUEST_MAX_BYTES: 104857600

        # 로그 관리 (24시간, 1GB 제한)
        KAFKA_LOG_RETENTION_HOURS: 24
        KAFKA_LOG_RETENTION_BYTES: 1073741824
        KAFKA_LOG_SEGMENT_BYTES: 536870912
        KAFKA_LOG_CLEANUP_POLICY: delete

        # 파티션 설정
        KAFKA_NUM_PARTITIONS: 3
        KAFKA_DEFAULT_REPLICATION_FACTOR: 1
        KAFKA_MIN_INSYNC_REPLICAS: 1

        # 오프셋 관리
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
        KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

        # 자동 토픽 생성
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

      volumes:
        - /home/ubuntu/yaldi/volumes/kafka:/var/lib/kafka/data
      networks:
        - network
      restart: unless-stopped

  backend:
    profiles: ["backend"]
    image: yaldi-backend:${VERSION:-latest}
    container_name: backend
    hostname: backend
    expose:
      - "8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      COOKIE_SECURE_ENABLED: "true"

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-yaldi}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Kafka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_CONSUMER_GROUP_ID: yaldi-consumer-group

      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: 3600000
      JWT_REFRESH_TOKEN_EXPIRATION: 604800000

      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}

      # GitHub OAuth
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      GITHUB_REDIRECT_URI: ${GITHUB_REDIRECT_URI}

      # OAuth2 공통
      OAUTH2_REDIRECT_URIS: ${OAUTH2_REDIRECT_URIS}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}

      # AWS S3
      AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
      AWS_SECRET_KEY: ${AWS_SECRET_KEY}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME}
      AWS_S3_REGION: ap-northeast-2

      # Frontend
      FRONTEND_URL: ${FRONTEND_URL:-https://yaldi.kr}

      # AI Server
      AI_SERVER_URL: ${AI_SERVER_URL}

      # Mail (선택적 - 사용한다면)
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}

      # Elasticsearch 설정
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      SPRING_DATA_ELASTICSEARCH_CLIENT_REACTIVE_ENDPOINTS: elasticsearch:9200

      TZ: UTC
    volumes:
      - /home/ubuntu/yaldi/volumes/backend-logs:/app/logs
    networks:
      - network
    restart: unless-stopped

  fastapi:
    profiles: ["ai"]
    image: yaldi-fastapi:${AI_VERSION:-latest}
    container_name: fastapi
    hostname: fastapi

    expose:
      - "8000"

    environment:
      # 기본 앱 설정
      APP_NAME: Yaldi AI Service
      APP_ENV: production
      DEBUG: false
      LOG_LEVEL: INFO
      HOST: 0.0.0.0
      PORT: 8000

      # Backend 연동
      SPRING_BACKEND_URL: ${SPRING_BACKEND_URL:-http://backend:8080}
      SPRING_API_KEY: ${FASTAPI_BACKEND_API_KEY:-}

      # SSAFY GMS / OpenAI 호출
      GMS_API_KEY: ${GMS_API_KEY}
      GMS_BASE_URL: ${GMS_BASE_URL:-https://gms.ssafy.io/gmsapi/api.openai.com/v1}
      OPENAI_MODEL: ${AI_MODEL_NAME:-gpt-4o-mini}
      OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE:-0.7}
      DEFAULT_LLM_PROVIDER: openai

      # ERD AI Settings
      ERD_MAX_TOKENS: ${ERD_MAX_TOKENS:-2000}
      ERD_TEMPERATURE: ${ERD_TEMPERATURE:-0.3}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-["https://yaldi.kr","https://api.yaldi.kr", "http://localhost:5173", "http://localhost:8080"]}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}

      # 테스트 DB 연결 (AI 전용)
      TEST_POSTGRES_URL: postgresql://test:test@test-postgres:5432/test_validation
      TEST_MYSQL_URL: mysql://test:test@test-mysql:3306/test_validation

      # Neo4j 연결 (그래프 DB)
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-yaldi308}

      # 기타
      TZ: Asia/Seoul

    depends_on:
      - test-postgres
      - test-mysql
      - neo4j

    volumes:
      - /home/ubuntu/yaldi/volumes/fastapi-logs:/app/logs

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    networks:
      - network

    restart: unless-stopped

  # ============ AI 전용 테스트 PostgreSQL ============
  test-postgres:
    profiles: ["ai"]
    image: postgres:15-alpine
    container_name: test-postgres
    hostname: test-postgres

    # 포트는 내부 통신만 (외부 노출 안함)
    expose:
      - "5432"

    # tmpfs: 메모리에만 저장 (재시작시 초기화, 빠름)
    tmpfs:
      - /var/lib/postgresql/data

    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test_validation
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      TZ: UTC

    deploy:
      resources:
        limits:
          memory: 300M
        reservations:
          memory: 100M

    networks:
      - network

    restart: unless-stopped

  # ============ AI 전용 테스트 MySQL ============
  test-mysql:
    profiles: ["ai"]
    image: mariadb:11
    container_name: test-mysql
    hostname: test-mysql

    expose:
      - "3306"

    # tmpfs: 메모리에만 저장 (재시작시 초기화, 빠름)
    tmpfs:
      - /var/lib/mysql

    environment:
      MYSQL_ROOT_PASSWORD: test
      MYSQL_USER: test
      MYSQL_PASSWORD: test
      MYSQL_DATABASE: test_validation
      TZ: UTC

    command: --skip-log-bin

    volumes:
       - /home/ubuntu/yaldi/volumes/mysql-init/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

    deploy:
      resources:
        limits:
          memory: 550M
        reservations:
          memory: 100M

    networks:
      - network

    restart: unless-stopped

  # ============ Neo4j (그래프 DB - ERD 유사도 검색용) ============
  neo4j:
    profiles: ["ai"]
    image: neo4j:5.15-community
    container_name: neo4j
    hostname: neo4j

    # Browser UI 접근용 (필요시 nginx 프록시 추가 가능)
    ports:
      - "7474:7474"  # HTTP Web UI
      - "7687:7687"  # Bolt protocol (애플리케이션 연결)

    environment:
      # 인증 설정 (username/password)
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-yaldi308}

      # 플러그인 (APOC, Graph Data Science)
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*

      # 메모리 설정 (2GB max)
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 512m

      # 기타
      NEO4J_dbms_default__listen__address: 0.0.0.0
      TZ: UTC

    volumes:
      - /home/ubuntu/yaldi/volumes/neo4j/data:/data
      - /home/ubuntu/yaldi/volumes/neo4j/logs:/logs

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2.5G
        reservations:
          cpus: '0.25'
          memory: 512M

    networks:
      - network

    restart: unless-stopped


  kafka-ui:
    profiles: ["monitoring"]
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    hostname: kafka-ui
    expose:
      - "8090"
    environment:
      KAFKA_CLUSTERS_0_NAME: yaldi-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      DYNAMIC_CONFIG_ENABLED: 'true'
      TZ: UTC
    networks:
      - network
    restart: unless-stopped

  nginx:
    profiles: ["nginx"]
    image: nginx:alpine
    container_name: nginx
    hostname: nginx
    group_add:
      - "1001"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /home/ubuntu/yaldi/nginx/conf.d:/etc/nginx/conf.d:ro
      - /home/ubuntu/yaldi/frontend/dist:/usr/share/nginx/html:ro
      - /home/ubuntu/yaldi/volumes/letsencrypt:/etc/letsencrypt:ro
      - /home/ubuntu/yaldi/volumes/certbot-www:/var/www/certbot
      - /home/ubuntu/yaldi/volumes/nginx-logs:/var/log/nginx
    environment:
      TZ: Asia/Seoul
    networks:
      - network
    restart: unless-stopped

networks:
  network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: yaldi-br0
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
