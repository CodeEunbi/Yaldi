pipeline {
    agent any
    
    environment {
        IMAGE_NAME = 'yaldi-backend'
        VERSION = "${BUILD_NUMBER}"
        TARGET_BRANCH = 'master'
    }
    
    options {
        gitLabConnection('GitLab')
    }
    
    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'gitlab-token',
                    url: 'https://lab.ssafy.com/s13-final/S13P31A308.git',
                    branch: "${TARGET_BRANCH}"
            }
        }
        
        stage('Check Backend Changes') {
            steps {
                script {
                    try {
                        def changes = sh(
                            script: 'git diff --name-only HEAD~1 HEAD | grep "^Back-End/" || true',
                            returnStdout: true
                        ).trim()
                        
                        if (changes) {
                            echo "âœ… Backend ë³€ê²½ ê°ì§€:\n${changes}"
                            env.BACKEND_CHANGED = 'true'
                        } else {
                            echo "â­ï¸ Backend ë³€ê²½ ì—†ìŒ (ë¹Œë“œ ìŠ¤í‚µ, ì¬ì‹œì‘ë§Œ)"
                            env.BACKEND_CHANGED = 'false'
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ ì²« ë¹Œë“œ"
                        env.BACKEND_CHANGED = 'true'
                    }
                }
            }
        }
        
        stage('Build Backend') {
            when {
                expression { env.BACKEND_CHANGED == 'true' }
            }
            steps {
                dir('Back-End/yaldi') {
                    sh '''
                        chmod +x gradlew
                        ./gradlew build -x test --no-daemon
                    '''
                }
            }
        }
        
        stage('Docker Build') {
            when {
                expression { env.BACKEND_CHANGED == 'true' }
            }
            steps {
                dir('Back-End/yaldi') {
                    sh """
                        docker build -t ${IMAGE_NAME}:${VERSION} .
                        docker tag ${IMAGE_NAME}:${VERSION} ${IMAGE_NAME}:latest
                    """
                }
            }
        }
        
        stage('Deploy Backend') {
            steps {
                withCredentials([
                    // Database (í•„ìˆ˜ 3ê°œ)
                    string(credentialsId: 'db-name', variable: 'DB_NAME'),
                    string(credentialsId: 'db-user', variable: 'DB_USER'),
                    string(credentialsId: 'db-password', variable: 'DB_PASSWORD'),
                    
                    // Redis (í•„ìˆ˜ 1ê°œ)
                    string(credentialsId: 'redis-password', variable: 'REDIS_PASSWORD'),
                    
                    // Kafka (ì„ íƒ 1ê°œ - ë””í´íŠ¸ ìˆì§€ë§Œ í†µì¼ ìœ„í•´)
                    string(credentialsId: 'kafka-cluster-id', variable: 'KAFKA_CLUSTER_ID'),
                    
                    // elasticsearch (ì„ íƒ 1ê°œ)
                    string(credentialsId: 'elasticsearch-uri', variable: 'ELASTICSEARCH_URI'),
                    
                    // JWT (í•„ìˆ˜ 1ê°œ)
                    string(credentialsId: 'jwt-secret', variable: 'JWT_SECRET'),
                    
                    // OAuth (í•„ìˆ˜ 7ê°œ)
                    string(credentialsId: 'google-client-id', variable: 'GOOGLE_CLIENT_ID'),
                    string(credentialsId: 'google-client-secret', variable: 'GOOGLE_CLIENT_SECRET'),
                    string(credentialsId: 'google-redirect-uri', variable: 'GOOGLE_REDIRECT_URI'),
                    string(credentialsId: 'github-client-id', variable: 'GITHUB_CLIENT_ID'),
                    string(credentialsId: 'github-client-secret', variable: 'GITHUB_CLIENT_SECRET'),
                    string(credentialsId: 'github-redirect-uri', variable: 'GITHUB_REDIRECT_URI'),
                    string(credentialsId: 'oauth2-redirect-uris', variable: 'OAUTH2_REDIRECT_URIS'),
                    
                    // CORS (í•„ìˆ˜ 1ê°œ)
                    string(credentialsId: 'cors-allowed-origins', variable: 'CORS_ALLOWED_ORIGINS'),
                    
                    // AWS S3 (í•„ìˆ˜ 3ê°œ)
                    string(credentialsId: 'aws-access-key', variable: 'AWS_ACCESS_KEY'),
                    string(credentialsId: 'aws-secret-key', variable: 'AWS_SECRET_KEY'),
                    string(credentialsId: 'aws-s3-bucket-name', variable: 'AWS_S3_BUCKET_NAME'),
                    
                    // AI Server (í•„ìˆ˜ 1ê°œ)
                    string(credentialsId: 'ai-server-url', variable: 'AI_SERVER_URL'),
                    
                    // Mail (ì„ íƒ 2ê°œ - ì‚¬ìš©í•œë‹¤ë©´)
                    string(credentialsId: 'mail-username', variable: 'MAIL_USERNAME'),
                    string(credentialsId: 'mail-password', variable: 'MAIL_PASSWORD')
                ]) {
                    script {
                        if (env.BACKEND_CHANGED == 'true') {
                            echo "ğŸš€ ìƒˆ ì´ë¯¸ì§€ë¡œ ë°°í¬ (ë²„ì „: ${VERSION})"
                            env.DEPLOY_VERSION = "${VERSION}"
                        } else {
                            echo "ğŸ”„ ê¸°ì¡´ ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘ (latest ì‚¬ìš©)"
                            env.DEPLOY_VERSION = "latest"
                        }
                    }
                    sh '''
                        # ë²„ì „ ì„¤ì •
                        export VERSION="$DEPLOY_VERSION"
                        
                        # Database
                        export DB_NAME="$DB_NAME"
                        export DB_USER="$DB_USER"
                        export DB_USERNAME="$DB_USER"  # backendìš© (DB_USERì™€ ë™ì¼)
                        export DB_PASSWORD="$DB_PASSWORD"
                        
                        # Redis
                        export REDIS_PASSWORD="$REDIS_PASSWORD"
                        
                        # Kafka
                        export KAFKA_CLUSTER_ID="$KAFKA_CLUSTER_ID"
                        
                        # elasticsearch
                        export ELASTICSEARCH_URI="$ELASTICSEARCH_URI"
                        
                        # JWT
                        export JWT_SECRET="$JWT_SECRET"
                        
                        # OAuth
                        export GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
                        export GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
                        export GOOGLE_REDIRECT_URI="$GOOGLE_REDIRECT_URI"
                        export GITHUB_CLIENT_ID="$GITHUB_CLIENT_ID"
                        export GITHUB_CLIENT_SECRET="$GITHUB_CLIENT_SECRET"
                        export GITHUB_REDIRECT_URI="$GITHUB_REDIRECT_URI"
                        export OAUTH2_REDIRECT_URIS="$OAUTH2_REDIRECT_URIS"
                        
                        # CORS
                        export CORS_ALLOWED_ORIGINS="$CORS_ALLOWED_ORIGINS"
                        
                        # AWS S3
                        export AWS_ACCESS_KEY="$AWS_ACCESS_KEY"
                        export AWS_SECRET_KEY="$AWS_SECRET_KEY"
                        export AWS_S3_BUCKET_NAME="$AWS_S3_BUCKET_NAME"
                        
                        # AI Server
                        export AI_SERVER_URL="$AI_SERVER_URL"
                        
                        # Mail (ì„ íƒì )
                        export MAIL_USERNAME="$MAIL_USERNAME"
                        export MAIL_PASSWORD="$MAIL_PASSWORD"
                        
                        # Backend ì¤‘ì§€
                        docker stop backend 2>/dev/null || true
                        docker rm backend 2>/dev/null || true
                        
                        # Backend ì‹œì‘
                        docker compose -f /workspace/docker-compose.yml --profile backend up -d
                        
                        echo "â³ Waiting for backend to start..."
                        sleep 5
                        
                        if docker ps | grep -q backend; then
                            echo "âœ… Backend container is running (ì´ë¯¸ì§€: yaldi-backend:$VERSION)"
                            docker logs backend --tail 30
                        else
                            echo "âŒ Backend failed to start"
                            docker logs backend --tail 50
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Cleanup Old Tags') {
            when {
                expression { env.BACKEND_CHANGED == 'true' }
            }
            steps {
                script {
                    echo "ğŸ§¹ ì˜¤ë˜ëœ íƒœê·¸ ì •ë¦¬ ì‹œì‘..."
                }
                sh '''
                    echo "ğŸ“‹ ì •ë¦¬ ì „:"
                    docker images yaldi-backend
                    
                    echo ""
                    echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ íƒœê·¸ ì‚­ì œ ì¤‘ (latest + ìµœê·¼ 3ê°œ ìœ ì§€)..."
                    
                    TAGS_TO_DELETE=$(docker images yaldi-backend --format "{{.Tag}}" | \
                      grep -E '^[0-9]+$' | \
                      sort -rn | \
                      tail -n +4)
                    
                    if [ -n "$TAGS_TO_DELETE" ]; then
                        echo "$TAGS_TO_DELETE" | while read tag; do
                            echo "  ì‚­ì œ: yaldi-backend:$tag"
                            docker rmi yaldi-backend:$tag 2>/dev/null || echo "    â†’ ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)"
                        done
                    else
                        echo "  ì‚­ì œí•  íƒœê·¸ ì—†ìŒ"
                    fi
                    
                    echo ""
                    echo "ğŸ“‹ ì •ë¦¬ í›„:"
                    docker images yaldi-backend
                    
                    echo "âœ… ì •ë¦¬ ì™„ë£Œ!"
                '''
            }
        }
    }
    
    post {
        success {
            script {
                if (env.BACKEND_CHANGED == 'true') {
                    echo "âœ… Backend ë¹Œë“œ + ë°°í¬ + ì •ë¦¬ ì™„ë£Œ! (Build #${VERSION})"
                } else {
                    echo "âœ… Backend ì¬ì‹œì‘ ì™„ë£Œ! (latest ì´ë¯¸ì§€ ì‚¬ìš©)"
                }
            }
            updateGitlabCommitStatus name: 'jenkins', state: 'success'

        }
        failure {
            echo "âŒ Backend ë°°í¬ ì‹¤íŒ¨!"
            updateGitlabCommitStatus name: 'jenkins', state: 'failed'
        }
    }
}