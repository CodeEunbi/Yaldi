pipeline {
    agent any
    
    environment {
        IMAGE_NAME = 'yaldi-fastapi'
        VERSION = "${BUILD_NUMBER}"
        TARGET_BRANCH = 'master'
    }
    
    options {
        gitLabConnection('GitLab')
    }
    
    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'gitlab-token',
                    url: 'https://lab.ssafy.com/s13-final/S13P31A308.git',
                    branch: "${TARGET_BRANCH}"
            }
        }
        
        stage('Check AI Changes') {
            steps {
                script {
                    try {
                        def changes = sh(
                            script: 'git diff --name-only HEAD~1 HEAD | grep "^AI/" || true',
                            returnStdout: true
                        ).trim()
                        
                        if (changes) {
                            echo "âœ… AI ë³€ê²½ ê°ì§€:\n${changes}"
                            env.AI_CHANGED = 'true'
                        } else {
                            echo "â­ï¸ AI ë³€ê²½ ì—†ìŒ (ë¹Œë“œ ìŠ¤í‚µ, ì¬ì‹œì‘ë§Œ)"
                            env.AI_CHANGED = 'false'
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ ì²« ë¹Œë“œ"
                        env.AI_CHANGED = 'true'
                    }
                }
            }
        }
        
        stage('Build FastAPI') {
            when {
                expression { env.AI_CHANGED == 'true' }
            }
            steps {
                dir('AI/yaldi') {
                    sh """
                        echo "ğŸ³ Building FastAPI Docker image..."
                        docker build -t ${IMAGE_NAME}:${VERSION} .
                        docker tag ${IMAGE_NAME}:${VERSION} ${IMAGE_NAME}:latest
                    """
                }
            }
        }
        
        stage('Deploy FastAPI') {
            steps {
                withCredentials([
                    string(credentialsId: 'gms-api-key', variable: 'GMS_API_KEY'),
                    string(credentialsId: 'fastapi-backend-api-key', variable: 'FASTAPI_BACKEND_API_KEY')
                ]) {
                    script {
                        // â­ Backendì™€ ë™ì¼í•œ ë²„ì „ ê´€ë¦¬ ë¡œì§
                        if (env.AI_CHANGED == 'true') {
                            echo "ğŸš€ ìƒˆ ì´ë¯¸ì§€ë¡œ ë°°í¬ (ë²„ì „: ${VERSION})"
                            env.DEPLOY_VERSION = "${VERSION}"
                        } else {
                            echo "ğŸ”„ ê¸°ì¡´ ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘ (latest ì‚¬ìš©)"
                            env.DEPLOY_VERSION = "latest"
                        }
                    }
                    sh '''
                        echo "ğŸš€ Deploy FastAPI (ì´ë¯¸ì§€: yaldi-fastapi:$DEPLOY_VERSION)..."
                        
                        # ë²„ì „ ì„¤ì •
                        export AI_VERSION="$DEPLOY_VERSION"
                        
                        # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ (ë¯¼ê° ì •ë³´)
                        export GMS_API_KEY="$GMS_API_KEY"
                        export FASTAPI_BACKEND_API_KEY="$FASTAPI_BACKEND_API_KEY"
                        
                        # ë‚˜ë¨¸ì§€ëŠ” docker-compose.ymlì— ê¸°ë³¸ê°’ ìˆìŒ!
                        
                        # FastAPI ì¤‘ì§€
                        docker stop fastapi 2>/dev/null || true
                        docker rm fastapi 2>/dev/null || true
                        
                        # FastAPI ì‹œì‘
                        docker compose -f /workspace/docker-compose.yml --profile ai up -d
                        
                        echo "â³ Waiting for FastAPI to start..."
                        sleep 5
                        
                        if docker ps | grep -q fastapi; then
                            echo "âœ… FastAPI container is running (ì´ë¯¸ì§€: yaldi-fastapi:$DEPLOY_VERSION)"
                            docker logs fastapi --tail 30
                        else
                            echo "âŒ FastAPI failed to start"
                            docker logs fastapi --tail 50
                            exit 1
                        fi
                    '''
                }
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    echo "ğŸ¥ FastAPI Health Check..."
                    sleep 5
                    
                    # Health check (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ)
                    MAX_RETRIES=5
                    RETRY_COUNT=0
                    
                    while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                        if docker exec fastapi curl -f http://localhost:8000/health 2>/dev/null; then
                            echo "âœ… FastAPI Health Check ì„±ê³µ"
                            exit 0
                        elif docker exec fastapi wget -q --spider http://localhost:8000/health 2>/dev/null; then
                            echo "âœ… FastAPI Health Check ì„±ê³µ (wget)"
                            exit 0
                        else
                            RETRY_COUNT=$((RETRY_COUNT + 1))
                            echo "â³ Health Check ì¬ì‹œë„ ($RETRY_COUNT/$MAX_RETRIES)..."
                            sleep 3
                        fi
                    done
                    
                    echo "âš ï¸ Health Check ì‹¤íŒ¨ (ì»¨í…Œì´ë„ˆëŠ” ì‹¤í–‰ ì¤‘)"
                    docker logs fastapi --tail 30
                '''
            }
        }
        
        stage('Cleanup Old Tags') {
            when {
                expression { env.AI_CHANGED == 'true' }
            }
            steps {
                script {
                    echo "ğŸ§¹ ì˜¤ë˜ëœ íƒœê·¸ ì •ë¦¬ ì‹œì‘..."
                }
                sh '''
                    echo "ğŸ“‹ ì •ë¦¬ ì „:"
                    docker images yaldi-fastapi
                    
                    echo ""
                    echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ íƒœê·¸ ì‚­ì œ ì¤‘ (latest + ìµœê·¼ 3ê°œ ìœ ì§€)..."
                    
                    TAGS_TO_DELETE=$(docker images yaldi-fastapi --format "{{.Tag}}" | \
                      grep -E '^[0-9]+$' | \
                      sort -rn | \
                      tail -n +4)
                    
                    if [ -n "$TAGS_TO_DELETE" ]; then
                        echo "$TAGS_TO_DELETE" | while read tag; do
                            echo "  ì‚­ì œ: yaldi-fastapi:$tag"
                            docker rmi yaldi-fastapi:$tag 2>/dev/null || echo "    â†’ ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)"
                        done
                    else
                        echo "  ì‚­ì œí•  íƒœê·¸ ì—†ìŒ"
                    fi
                    
                    echo ""
                    echo "ğŸ“‹ ì •ë¦¬ í›„:"
                    docker images yaldi-fastapi
                    
                    echo "âœ… ì •ë¦¬ ì™„ë£Œ!"
                '''
            }
        }
    }
    
    post {
        success {
            script {
                if (env.AI_CHANGED == 'true') {
                    echo "âœ… AI ë¹Œë“œ + ë°°í¬ + ì •ë¦¬ ì™„ë£Œ! (Build #${VERSION})"
                } else {
                    echo "âœ… AI ì¬ì‹œì‘ ì™„ë£Œ! (latest ì´ë¯¸ì§€ ì‚¬ìš©)"
                }
            }
            updateGitlabCommitStatus name: 'jenkins-ai', state: 'success'
        }
        failure {
            echo "âŒ AI ë°°í¬ ì‹¤íŒ¨!"
            updateGitlabCommitStatus name: 'jenkins-ai', state: 'failed'
        }
    }
}
