pipeline {
    agent any

    environment {
        TARGET_BRANCH = 'master'
        NODE_OPTIONS = '--max-old-space-size=4096'
    }
    
    options {
        gitLabConnection('GitLab')
    }
    
    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'gitlab-token',
                    url: 'https://lab.ssafy.com/s13-final/S13P31A308.git',
                    branch: "${TARGET_BRANCH}"
            }
        }
        
        stage('Check Frontend Changes') {
            steps {
                script {
                    try {
                        def changes = sh(
                            script: 'git diff --name-only HEAD~1 HEAD | grep "^Front-End/" || true',
                            returnStdout: true
                        ).trim()
                        
                        if (changes) {
                            echo "âœ… Frontend ë³€ê²½ ê°ì§€:\n${changes}"
                            env.FRONTEND_CHANGED = 'true'
                        } else {
                            echo "â­ï¸ Frontend ë³€ê²½ ì—†ìŒ (ë¹Œë“œ ìŠ¤í‚µ, ì¬ì‹œì‘ë§Œ)"
                            env.FRONTEND_CHANGED = 'false'
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ ì²« ë¹Œë“œ"
                        env.FRONTEND_CHANGED = 'true'
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            when {
                expression { env.FRONTEND_CHANGED == 'true' }
            }
            steps {
                dir('Front-End/yaldi') {
                    sh 'npm ci'
                }
            }
        }
        
        stage('Build Frontend') {
            when {
                expression { env.FRONTEND_CHANGED == 'true' }
            }
            steps {
                withCredentials([
                    string(credentialsId: 'frontend-api-url', variable: 'VITE_API_BASE_URL')
                ]) {
                    dir('Front-End/yaldi') {
                        sh '''
                            npm run build
                            
                            mkdir -p /workspace/frontend
                            rm -rf /workspace/frontend/dist
                            cp -r dist /workspace/frontend/
                    
                            # ê¶Œí•œ í™•ì¸
                            ls -la /workspace/frontend/dist/
                        '''
                    }
                }
            }
        }
        
        stage('Deploy Frontend') {
            steps {
                script {
                    if (env.FRONTEND_CHANGED == 'true') {
                        echo "ğŸš€ ìƒˆ ë¹Œë“œë¡œ ë°°í¬ (Build #${BUILD_NUMBER})"
                    } else {
                        echo "ğŸ”„ Nginx ì¬ì‹œì‘ë§Œ ìˆ˜í–‰"
                    }
                }
                sh '''
                    docker compose -f /workspace/docker-compose.yml restart nginx
                    
                    echo "â³ Waiting for nginx to restart..."
                    sleep 3
                    
                    if docker ps | grep -q nginx; then
                        echo "âœ… Nginx is running"
                        docker logs nginx --tail 10
                    else
                        echo "âŒ Nginx failed to restart"
                        docker logs nginx --tail 30
                        exit 1
                    fi
                '''
            }
        }
    }
    
    post {
        success {
            script {
                if (env.FRONTEND_CHANGED == 'true') {
                    echo "âœ… Frontend ë¹Œë“œ + ë°°í¬ ì™„ë£Œ! (Build #${BUILD_NUMBER})"
                } else {
                    echo "âœ… Nginx ì¬ì‹œì‘ ì™„ë£Œ!"
                }
            }
            updateGitlabCommitStatus name: 'jenkins', state: 'success'

        }
        failure {
            echo "âŒ Frontend ë°°í¬ ì‹¤íŒ¨!"
            updateGitlabCommitStatus name: 'jenkins', state: 'failed'
        }
        cleanup {
            script {
                if (env.FRONTEND_CHANGED == 'true') {
                    dir('Front-End/yaldi') {
                        sh 'rm -rf node_modules dist || true'
                    }
                }
            }
        }
    }
}