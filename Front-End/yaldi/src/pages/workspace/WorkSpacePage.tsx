import React, { useCallback, useEffect, useState, useRef } from 'react';
import { useParams } from 'react-router-dom';
import LeftSideBar from './LeftSideBar';
import RightSideBar from './RightSideBar';
import WorkspaceCanvas, { type WorkspaceMode } from './WorkspaceCanvas';
import { WorkspaceProvider, useWorkspace } from './WorkSpace';
import type { WorkspaceTable } from './WorkSpace';
import ImportModal from './components/ImportModal';
import ExportModal from './components/ExportModal';
import ImportResultModal from './components/ImportResultModal';
import ImportRetryModal from './components/ImportRetryModal';
import type { ExportDatabase } from './components/ExportModal';
import BuildSuccessIcon from '../../assets/icons/build_success_icon.svg?react';
import { ErdWebSocketClient } from '../../services/websocket';
import { WebSocketTestPanel } from '../../components/common/WebSocketTestPanel';
import { useAuthStore } from '../../stores/authStore';
import RemoteCursor from './components/RemoteCursor';
import type { RemoteCursor as RemoteCursorType } from '../../services/websocket/types';

const dummySqlPreview: Record<ExportDatabase, string> = {
  mysql: `-- MySQL Export ì˜ˆì‹œ
CREATE TABLE customers (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO customers (name, email)
VALUES
  ('í™ê¸¸ë™', 'hong.gildong@example.com'),
  ('ê¹€ì˜í¬', 'kim.younghee@example.com');`,
  postgresql: `-- PostgreSQL Export ì˜ˆì‹œ
CREATE TABLE customers (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO customers (name, email)
VALUES
  ('í™ê¸¸ë™', 'hong.gildong@example.com'),
  ('ê¹€ì˜í¬', 'kim.younghee@example.com');`,
};

const IMPORT_ERROR_SQL = `CREATE TABLE "snapshots" (
  "snapshot_key" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  "project_key" INTEGER NOT NULL,
  "created_by" INTEGER NOT NULL,
  "name" VARCHAR(500) NOT NULL DEFAULT '',
  "schema" JSONB NOT NULL DEFAULT '{}',
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT now()
);`;

const IMPORT_ERROR_CHANGE_SUMMARY = [
  'snapshots.snapshot_key ì»¬ëŸ¼ì„ BIGINT IDENTITYë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.',
  'schema ì»¬ëŸ¼ì„ JSONB íƒ€ì…ìœ¼ë¡œ ì§€ì •í•˜ì—¬ JSON êµ¬ì¡° ì €ì¥ì„ ì§€ì›í•©ë‹ˆë‹¤.',
  'created_at ì»¬ëŸ¼ì— ê¸°ë³¸ê°’ now()ë¥¼ ì¶”ê°€í•˜ì—¬ ìƒì„± ì‹œê°„ì„ ìë™ ì €ì¥í•©ë‹ˆë‹¤.',
];

const IMPORT_CORRECTED_TABLES: WorkspaceTable[] = [
  {
    id: 'table-projects',
    name: 'projects',
    identifier: 'projects',
    x: 180,
    y: 140,
    color: 'blue',
    columns: [
      {
        id: 'column-projects-project-key',
        isKey: true,
        logicalName: 'í”„ë¡œì íŠ¸ í‚¤',
        physicalName: 'project_key',
        domain: 'PK',
        dataType: 'INTEGER',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í”„ë¡œì íŠ¸ ì‹ë³„ì',
      },
      {
        id: 'column-projects-name',
        isKey: false,
        logicalName: 'í”„ë¡œì íŠ¸ëª…',
        physicalName: 'name',
        domain: 'VARCHAR',
        dataType: 'VARCHAR(255)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í”„ë¡œì íŠ¸ ì´ë¦„',
      },
      {
        id: 'column-projects-owner',
        isKey: false,
        logicalName: 'ìƒì„±ì',
        physicalName: 'created_by',
        domain: 'INTEGER',
        dataType: 'INTEGER',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í”„ë¡œì íŠ¸ ìƒì„±ì',
      },
    ],
  },
  {
    id: 'table-snapshots',
    name: 'snapshots',
    identifier: 'snapshots',
    x: 420,
    y: 120,
    color: 'user2',
    columns: [
      {
        id: 'column-snapshots-key',
        isKey: true,
        logicalName: 'ìŠ¤ëƒ…ìƒ· í‚¤',
        physicalName: 'snapshot_key',
        domain: 'PK',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: 'IDENTITY',
        comment: 'ìŠ¤ëƒ…ìƒ· ì‹ë³„ì',
      },
      {
        id: 'column-snapshots-project-key',
        isKey: false,
        logicalName: 'í”„ë¡œì íŠ¸ í‚¤',
        physicalName: 'project_key',
        domain: 'INTEGER',
        dataType: 'INTEGER',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ì—°ê²°ëœ í”„ë¡œì íŠ¸',
      },
      {
        id: 'column-snapshots-schema',
        isKey: false,
        logicalName: 'ìŠ¤í‚¤ë§ˆ',
        physicalName: 'schema',
        domain: 'JSONB',
        dataType: 'JSONB',
        allowNull: 'NOT NULL',
        defaultValue: '{}',
        comment: 'ERD JSON ë°ì´í„°',
      },
      {
        id: 'column-snapshots-created-at',
        isKey: false,
        logicalName: 'ìƒì„± ì¼ì‹œ',
        physicalName: 'created_at',
        domain: 'TIMESTAMPTZ',
        dataType: 'TIMESTAMPTZ',
        allowNull: 'NOT NULL',
        defaultValue: 'now()',
        comment: 'ìƒì„± ì‹œê°',
      },
    ],
  },
  {
    id: 'table-entities',
    name: 'entities',
    identifier: 'entities',
    x: 260,
    y: 340,
    color: 'user3',
    columns: [
      {
        id: 'column-entities-key',
        isKey: true,
        logicalName: 'ì—”í‹°í‹° í‚¤',
        physicalName: 'entity_key',
        domain: 'PK',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: 'IDENTITY',
        comment: 'ì—”í‹°í‹° ì‹ë³„ì',
      },
      {
        id: 'column-entities-snapshot-key',
        isKey: false,
        logicalName: 'ìŠ¤ëƒ…ìƒ· í‚¤',
        physicalName: 'snapshot_key',
        domain: 'BIGINT',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ì—°ê²°ëœ ìŠ¤ëƒ…ìƒ·',
      },
      {
        id: 'column-entities-name',
        isKey: false,
        logicalName: 'ì—”í‹°í‹°ëª…',
        physicalName: 'name',
        domain: 'VARCHAR',
        dataType: 'VARCHAR(255)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ERD ì—”í‹°í‹° ì´ë¦„',
      },
    ],
  },
  {
    id: 'table-entity-columns',
    name: 'entity_columns',
    identifier: 'entity_columns',
    x: 520,
    y: 320,
    color: 'user4',
    columns: [
      {
        id: 'column-entity-columns-key',
        isKey: true,
        logicalName: 'ì»¬ëŸ¼ í‚¤',
        physicalName: 'entity_column_key',
        domain: 'PK',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: 'IDENTITY',
        comment: 'ì—”í‹°í‹° ì»¬ëŸ¼ ì‹ë³„ì',
      },
      {
        id: 'column-entity-columns-entity-key',
        isKey: false,
        logicalName: 'ì—”í‹°í‹° í‚¤',
        physicalName: 'entity_key',
        domain: 'BIGINT',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ì—°ê²°ëœ ì—”í‹°í‹°',
      },
      {
        id: 'column-entity-columns-name',
        isKey: false,
        logicalName: 'ì»¬ëŸ¼ëª…',
        physicalName: 'column_name',
        domain: 'VARCHAR',
        dataType: 'VARCHAR(255)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í•„ë“œ ëª…ì¹­',
      },
      {
        id: 'column-entity-columns-type',
        isKey: false,
        logicalName: 'ë°ì´í„° íƒ€ì…',
        physicalName: 'data_type',
        domain: 'VARCHAR',
        dataType: 'VARCHAR(100)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ë°ì´í„° íƒ€ì…',
      },
    ],
  },
];

type ImportResultState = {
  type: 'error';
  correctedSql: string;
  changeSummary: string[];
  tables: WorkspaceTable[];
};

const cloneTables = (tables: WorkspaceTable[]): WorkspaceTable[] =>
  tables.map((table) => ({
    ...table,
    columns: table.columns.map((column) => ({ ...column })),
  }));

interface WorkspaceLayoutProps {
  mode?: WorkspaceMode;
}

const WorkspaceLayout: React.FC<WorkspaceLayoutProps> = ({ mode = 'edit' }) => {
  const { activeTool, setActiveTool, replaceTables, updateTablePosition } = useWorkspace();
  const isViewMode = mode === 'view';
  const [sqlPreview, setSqlPreview] = useState('');
  const [isPreviewLoading, setIsPreviewLoading] = useState(false);
  const [isCopying, setIsCopying] = useState(false);
  const [showCopyToast, setShowCopyToast] = useState(false);
  const [isImportProcessing, setIsImportProcessing] = useState(false);
  const [importResult, setImportResult] = useState<ImportResultState | null>(
    null,
  );
  const [isImportResultOpen, setIsImportResultOpen] = useState(false);
  const [isImportRetryOpen, setIsImportRetryOpen] = useState(false);

  // URLì—ì„œ projectKey ê°€ì ¸ì˜¤ê¸°
  const params = useParams<{ projectKey: string }>();
  const setProjectKey = useAuthStore((state) => state.setProjectKey);

  // WebSocket ê´€ë ¨ ìƒíƒœ
  const wsClientRef = useRef<ErdWebSocketClient | null>(null);
  const [isWsConnected, setIsWsConnected] = useState(false);
  const currentUser = useAuthStore((state) => state.currentUser);

  // ì›ê²© ì»¤ì„œ ìƒíƒœ (ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ì»¤ì„œ)
  const [remoteCursors, setRemoteCursors] = useState<Record<string, RemoteCursorType>>({});

  // projectKeyë¥¼ authStoreì— ì €ì¥
  useEffect(() => {
    if (params.projectKey) {
      const projectKeyNum = parseInt(params.projectKey, 10);
      if (!isNaN(projectKeyNum)) {
        setProjectKey(projectKeyNum);
      }
    }
  }, [params.projectKey, setProjectKey]);

  // WebSocket ì´ˆê¸°í™”
  useEffect(() => {
    if (isViewMode) return; // ë·°ì–´ ëª¨ë“œì—ì„œëŠ” WebSocket ì‚¬ìš© ì•ˆ í•¨

    // authStoreì—ì„œ ì‹¤ì œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const projectKey = useAuthStore.getState().projectKey;

    // projectKeyê°€ ì—†ìœ¼ë©´ ì—°ê²°í•˜ì§€ ì•ŠìŒ
    if (!projectKey) {
      console.warn('âš ï¸ No projectKey found, skipping WebSocket connection');
      return;
    }

    console.log('ğŸ”Œ Initializing WebSocket...');
    console.log('Project Key:', projectKey);
    console.log('User:', currentUser);

    // accessTokenì€ ì„ì‹œë¡œ ë¹ˆ ë¬¸ìì—´ (ì¿ í‚¤ë¡œ ì¸ì¦ ì²˜ë¦¬)
    const wsClient = new ErdWebSocketClient({
      projectKey,
      accessToken: '',
    });

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    wsClient.setEventHandlers({
      onTableMove: (event) => {
        console.log('ğŸ“¥ Received TABLE_MOVE:', event);
        const tableEvent = event.event as { tableKey: number; xPosition: number; yPosition: number };

        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ (ì´ë¯¸ ë¡œì»¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ)
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í…Œì´ë¸” ì´ë™ â†’ í™”ë©´ ì—…ë°ì´íŠ¸
        updateTablePosition(`table-${tableEvent.tableKey}`, {
          x: tableEvent.xPosition,
          y: tableEvent.yPosition,
        });
      },
      onCursorMove: (event) => {
        console.log('ğŸ“¥ Received CURSOR_MOVE:', event);
        const cursorEvent = event.event as {
          userEmail?: string;
          userName?: string;
          userColor?: string;
          xPosition: number;
          yPosition: number;
        };

        // ìê¸° ì»¤ì„œëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì»¤ì„œ ì—…ë°ì´íŠ¸
        const userEmail = cursorEvent.userEmail || `user-${event.userKey}`;
        setRemoteCursors((prev) => ({
          ...prev,
          [userEmail]: {
            userEmail,
            userName: cursorEvent.userName || 'ìµëª…',
            userColor: cursorEvent.userColor || '#3b82f6',
            xPosition: cursorEvent.xPosition,
            yPosition: cursorEvent.yPosition,
          },
        }));
      },
      onTableLock: (event) => {
        console.log('ğŸ“¥ Received TABLE_LOCK:', event);
      },
      onTableUnlock: (event) => {
        console.log('ğŸ“¥ Received TABLE_UNLOCK:', event);
      },
    });

    wsClientRef.current = wsClient;

    // ìë™ìœ¼ë¡œ ì—°ê²° ì‹œì‘
    wsClient.connect();
    setIsWsConnected(true);

    return () => {
      console.log('ğŸ”Œ Cleaning up WebSocket...');
      wsClient.disconnect();
      setIsWsConnected(false);
    };
  }, [isViewMode, currentUser, updateTablePosition]);

  // WebSocket í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
  const handleWsConnect = useCallback(() => {
    if (wsClientRef.current) {
      wsClientRef.current.connect();
      setIsWsConnected(true);
      console.log('âœ… WebSocket connection initiated');
    }
  }, []);

  const handleWsDisconnect = useCallback(() => {
    if (wsClientRef.current) {
      wsClientRef.current.disconnect();
      setIsWsConnected(false);
      console.log('âŒ WebSocket disconnected');
    }
  }, []);

  const handleWsSendTest = useCallback(() => {
    if (wsClientRef.current) {
      // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€: í…Œì´ë¸” ì´ë™
      wsClientRef.current.sendTableMove(1, 100, 200);
      console.log('ğŸ“¤ Sent test TABLE_MOVE message');
    }
  }, []);


  const handleCloseImportModal = useCallback(() => {
    setActiveTool('cursor');
    setIsImportProcessing(false);
  }, [setActiveTool]);

  const handleImportSubmit = useCallback(
    (ddl: string) => {
      setIsImportProcessing(true);
      window.setTimeout(() => {
        const trimmed = ddl.trim();
        const hasCreateTable = /create\s+table/i.test(trimmed);
        const forceError = /force_error/i.test(trimmed);
        const isValid = trimmed.length > 0 && hasCreateTable && !forceError;

        if (isValid) {
          replaceTables(cloneTables(IMPORT_CORRECTED_TABLES));
          setImportResult(null);
          setIsImportResultOpen(false);
        } else {
          setImportResult({
            type: 'error',
            correctedSql: IMPORT_ERROR_SQL,
            changeSummary: IMPORT_ERROR_CHANGE_SUMMARY,
            tables: cloneTables(IMPORT_CORRECTED_TABLES),
          });
          setIsImportResultOpen(true);
        }

        setIsImportProcessing(false);
        handleCloseImportModal();
      }, 600);
    },
    [handleCloseImportModal, replaceTables],
  );

  const handleImportResultConfirm = useCallback(() => {
    if (importResult?.tables) {
      replaceTables(cloneTables(importResult.tables));
    }
    setImportResult(null);
    setIsImportResultOpen(false);
  }, [importResult, replaceTables]);

  const handleImportResultClose = useCallback(() => {
    setImportResult(null);
    setIsImportResultOpen(false);
    setIsImportRetryOpen(true);
  }, []);

  const handleImportRetryConfirm = useCallback(() => {
    setIsImportRetryOpen(false);
    setActiveTool('import');
    setIsImportProcessing(false);
  }, [setActiveTool]);

  const handleCloseExportModal = useCallback(() => {
    setActiveTool('cursor');
    setSqlPreview('');
    setIsPreviewLoading(false);
    setIsCopying(false);
    setShowCopyToast(false);
  }, [setActiveTool]);

  const handlePreviewClick = useCallback((database: ExportDatabase) => {
    setIsPreviewLoading(true);
    setTimeout(() => {
      setSqlPreview(dummySqlPreview[database]);
      setIsPreviewLoading(false);
    }, 400);
  }, []);

  const handleCopyClick = useCallback(
    async (database: ExportDatabase) => {
      const textToCopy =
        sqlPreview && sqlPreview.trim().length > 0
          ? sqlPreview
          : dummySqlPreview[database];

      if (!textToCopy) {
        return;
      }

      if (!sqlPreview || sqlPreview.trim().length === 0) {
        setSqlPreview(dummySqlPreview[database]);
      }

      setIsCopying(true);
      try {
        if (
          navigator.clipboard &&
          typeof navigator.clipboard.writeText === 'function'
        ) {
          await navigator.clipboard.writeText(textToCopy);
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = textToCopy;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }
        setShowCopyToast(true);
      } catch (error) {
        console.error('SQL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', error);
      } finally {
        setIsCopying(false);
      }
    },
    [sqlPreview],
  );

  useEffect(() => {
    if (!showCopyToast) {
      return;
    }

    const timer = window.setTimeout(() => {
      setShowCopyToast(false);
    }, 2000);

    return () => window.clearTimeout(timer);
  }, [showCopyToast]);

  const isImportModalOpen = activeTool === 'import';
  const isExportModalOpen = activeTool === 'export';

  return (
    <>
      <div className="flex w-full flex-col">
        <div className="flex h-[calc(100vh-70px)] min-h-[calc(100vh-70px)] overflow-hidden bg-my-white">
          {/* ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì™¼ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */}
          {!isViewMode && <LeftSideBar />}
          <div className="flex min-h-0 flex-1 overflow-hidden">
            <WorkspaceCanvas mode={mode} />
          </div>
          {/* ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */}
          {!isViewMode && <RightSideBar />}
        </div>
      </div>

      {/* ë·°ì–´ ëª¨ë“œì—ì„œëŠ” Import/Export ëª¨ë‹¬ ìˆ¨ê¹€ */}
      {!isViewMode && (
        <>
          <ImportModal
            isOpen={isImportModalOpen}
            onClose={handleCloseImportModal}
            onSubmit={handleImportSubmit}
            isProcessing={isImportProcessing}
          />
          <ExportModal
            isOpen={isExportModalOpen}
            onClose={handleCloseExportModal}
            sqlPreview={sqlPreview}
            onClickPreview={handlePreviewClick}
            onClickDownload={handleCopyClick}
            isPreviewLoading={isPreviewLoading}
            isDownloadLoading={isCopying}
          />
          {importResult && (
            <ImportResultModal
              isOpen={isImportResultOpen}
              onClose={handleImportResultClose}
              onConfirm={handleImportResultConfirm}
              type={importResult.type}
              correctedSql={importResult.correctedSql}
              changeSummary={importResult.changeSummary}
            />
          )}
          <ImportRetryModal
            isOpen={isImportRetryOpen}
            message="SQLë¬¸ì„ ë‹¤ì‹œ ì…ë ¥í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
            onConfirm={handleImportRetryConfirm}
          />
        </>
      )}
      {showCopyToast && (
        <div className="fixed bottom-6 left-1/2 z-50">
          <div className="-translate-x-1/2 transform">
            <div className="flex items-center gap-2 rounded-[10px] bg-my-black px-6 py-3 text-my-white shadow-lg animate-fadeIn">
              <BuildSuccessIcon className="h-5 w-5" />
              <span className="font-pretendard text-sm font-medium">
                SQLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.
              </span>
            </div>
          </div>
        </div>
      )}

      {/* WebSocket í…ŒìŠ¤íŠ¸ íŒ¨ë„ (ê°œë°œ ì¤‘ì—ë§Œ í‘œì‹œ) */}
      {!isViewMode && import.meta.env.DEV && (
        <WebSocketTestPanel
          isConnected={isWsConnected}
          onConnect={handleWsConnect}
          onDisconnect={handleWsDisconnect}
          onSendTestMessage={handleWsSendTest}
        />
      )}

      {/* ì›ê²© ì»¤ì„œë“¤ ë Œë”ë§ */}
      {!isViewMode &&
        Object.values(remoteCursors).map((cursor) => (
          <RemoteCursor
            key={cursor.userEmail}
            userName={cursor.userName}
            userColor={cursor.userColor}
            xPosition={cursor.xPosition}
            yPosition={cursor.yPosition}
          />
        ))}
    </>
  );
};

interface WorkSpacePageProps {
  mode?: WorkspaceMode;
}

const WorkSpacePage: React.FC<WorkSpacePageProps> = ({ mode = 'edit' }) => {
  return (
    <WorkspaceProvider>
      <WorkspaceLayout mode={mode} />
    </WorkspaceProvider>
  );
};

export default WorkSpacePage;
